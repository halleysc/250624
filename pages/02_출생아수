import streamlit as st
import pandas as pd
import os
import re

st.set_page_config(page_title="0세 인구 상위 동 분석", layout="wide")

st.title("2025년 5월 0세 인구 기준 연령별 인구 분석")
st.write("0세 인구가 많은 상위 5개 동의 전체 연령별 인구를 선 그래프로 시각화합니다.")

# 기본 파일 경로
default_file_path = "/mnt/data/202505_202505_연령별인구현황_월간.csv"

# 파일 업로드 받기
uploaded_file = st.file_uploader("📁 CSV 파일 업로드 (선택 사항)", type="csv")

# 사용할 파일 결정
if uploaded_file is not None:
    st.success("✅ 업로드된 파일이 사용됩니다.")
    file_to_use = uploaded_file
elif os.path.exists(default_file_path):
    st.info("ℹ️ 업로드된 파일이 없으므로 기본 파일을 사용합니다.")
    file_to_use = default_file_path
else:
    st.error("❌ 사용할 수 있는 CSV 파일이 없습니다.")
    st.stop()

# 데이터 읽기
df = pd.read_csv(file_to_use, encoding="euc-kr")

# 주요 열
admin_col = "행정구역"
age_prefix = "2025년05월_계_"
age_cols = [col for col in df.columns if col.startswith(age_prefix) and ("세" in col or "100세 이상" in col)]
age_col_0 = f"{age_prefix}0세"

# 쉼표 제거 후 정수 변환
for col in age_cols:
    df[col] = df[col].astype(str).str.replace(",", "").astype(int)

# 행정구역에서 '서울특별시 ㅇㅇ구' 제거 → 동 이름만 남기기
df[admin_col] = df[admin_col].apply(lambda x: re.sub(r'^서울특별시\s+\S+\s+', '', x).strip())

# 0세 인구가 많은 상위 5개 동 추출
top5_df = df.sort_values(by=age_col_0, ascending=False).head(5)

# 연령 라벨 정리
age_labels = [col.replace(age_prefix, "") for col in age_cols]

# 시각화용 데이터 구성
plot_df = top5_df[[admin_col] + age_cols].copy()
plot_df.columns = [admin_col] + age_labels
plot_df = plot_df.set_index(admin_col).T
plot_df.index.name = "연령"

# 📊 그래프 출력
st.subheader("📊 연령별 인구 선 그래프 (0세 인구 기준 상위 5개 동)")
st.line_chart(plot_df)

# 📄 원본 데이터 일부 표시
st.subheader("🧾 원본 데이터 미리보기")
st.dataframe(df[[admin_col, age_col_0] + age_cols[:5]])
